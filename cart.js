$(document).ready(function(){onCartModalOpen();dismissPopoverForSize();clearSelected();onCheckout();});function onCheckout(){$("#cart_checkout_form").click(function(){var localCart=JSON.parse(localStorage.getItem("cart"));console.log("syncing local storage");if(localCart!=null){moveLocalStorageToDatabase();}window.location="/checkout";});}function refreshCartOnFocus(){$(window).focus(function(){console.log("refreshing cart on focus");$('#myModal2').removeData();displayCart();});}function clearSelected(){$("#selected_color").val("NIL");$("#selected_size").val("NIL");$(".color_image").each(function(){$(this).css("border","2px solid #00B9E5");});$("#quantity_text").val(1);}function dismissPopoverForSize(){$('body').on('click',function(e){$('[data-toggle="popover"]').each(function(){if(!$(this).is(e.target)&&$(this).has(e.target).length===0&&$('#pop_a').has(e.target).length===0){if(e.target.id!='add_to_cart_button'){$(this).popover('hide');}}});});}function onSizeSelect(size,stock){if(parseInt(stock)===0){$("#add_to_cart_button").prop("disabled",true);}else{$("#add_to_cart_button").prop("disabled",false);}$("#selected_size").val(size);$("#quantity_text").val(1);$("label[for='quantity']").html(1);$("#stock_left").html("Only "+stock+" left");}function shorten(text,maxLength){var ret=text;if(ret.length>maxLength){ret=ret.substr(0,maxLength-3)+"...";}return ret;}function onCartModalOpen(){$('#myModal2').on('shown.bs.modal',function(){console.log("displaying cart onCartModalOpen");displayCart();})}function displayCart(){moveLocalStorageToDatabase();var savedProducts=$.ajax({url:"/cart/viewCart",method:'GET',contentType:"application/json",global:false,async:false,success:function(data){return data;},failure:function(data){alert("failed "+data);}}).responseText;var cookieProducts=JSON.parse(localStorage.getItem("cart"));var html=items(cookieProducts);if(savedProducts!=""){console.log("saved products ="+savedProducts);html+=items(JSON.parse(savedProducts).items);}if(html===""){$("#proceed").hide();$("#items").html("Cart is Empty!");}else{$("#items").html(html);$("#proceed").show();}}function items(products){var html="";var total=0;if(products!=null){for(i=0;i<products.length;i++){var pid=products[i].pid;var name=products[i].name;var price=products[i].price;var image=products[i].image;var quantity=products[i].quantity;var size=products[i].size;var unitPrice=products[i].unitPrice;var stock=products[i].stock;console.log("stock in items "+stock);var displaySize='SIZE: '+size;if(size==='NA'){displaySize='';}var node='<table style="width:100%;margin-bottom:25px; font-size:10px;"><tr class="cart_product_tr"><td style="width:33%; min-width:100px;" class="cart_product-image"><a target="_blank" href="product?id='+pid+'"><img	src="'+image+'" height="75" width="50" /></a></td>'+'<td class="padd_left" style="width:33%"><table><tr><td class="cart_product-name"><div>'+shorten(name,25)+'</div></td></tr><tr><td class="cart_product-name">'+displaySize+'</td></tr><tr><td class="cart_product-quantity">'+'<input type="button" class="btn btn-default" style="cursor: pointer;" onclick="decreaseOneQuantityFromCart(\''+pid+'\',\''+size+'\')" value="-"/></input><label id="cart_quantity_label'+pid+'" style="margin-left:5px; margin-right:5px">'+quantity+'</label><input type="button" class="btn btn-default" onclick="addQuantityFromMyCart(\''+size+'\',\''+pid+'\','+unitPrice+',\''+name+'\',\''+image+'\','+stock+')" value="+"></input>'+'</td></tr></table>'+'</td>'+'</td><td style="width:33%; padding-left:10%;" class="padd_left"><table><tr><td class="cart_product-price"><div id="cart_unit_total_price'+pid+'">&#8377;'+price+'</div></td></tr><tr><td><a href="#0" onclick="removeFromCart(\''+pid+'\',\''+size+'\')" class="cart_product-remove">Remove</a></td></tr></table></td></tr></table>';html+=node;total+=parseInt(price);}}return html;}function addQuantityFromMyCart(size,pid,price,name,image,stock){var source="ADD_CART_QUANTITY";addToCart(source,size,pid,price,name,image,'ADDTOCARTFROMQUANTITY',stock);}function decreaseCartQuantity(pid){var quantity=$("#cart_quantity_label"+pid).text();var updatedQuantity=parseInt(quantity);if(updatedQuantity>1){$("#cart_quantity_label"+pid).text(--updatedQuantity);}}function moveLocalStorageToDatabase(){console.log("Moving LocalStorage To Database");var localCart=JSON.parse(localStorage.getItem("cart"));if(localCart!=null){var savedProducts=$.ajax({url:"/cart/addToCart",method:'POST',contentType:"application/json",data:JSON.stringify(localCart),global:false,async:false,success:function(data){return data;}}).responseText;if(savedProducts==="authorized"){localStorage.removeItem('cart');}}}function removeFromCart(pidToBeRemoved,size){var savedProducts=$.ajax({url:"/cart/removeFromCart/"+pidToBeRemoved+"/size/"+size,method:'GET',global:false,async:false,success:function(data){if(data==="unauthorized"||data==="false"){removeCartItemFromLocalStorage(pidToBeRemoved,size);}displayCart();return data;}}).responseText;}function removeCartItemFromLocalStorage(pidToBeRemoved,size){var cart=localStorage.getItem("cart");var products=JSON.parse(cart);if(products!=null){for(i=0;i<products.length;i++){var pid=products[i].pid;if(pid===pidToBeRemoved&&size===products[i].size){products.splice(i,1);localStorage.setItem("cart",JSON.stringify(products));break;}}}}function increaseQuantityInProductPage(){var size=$("#selected_size").val();var stock=$("#"+size+"-stock").val();var quantity=$("#quantity_text").val();if(parseInt(stock)<=parseInt(quantity)){return;}quantity=parseInt(quantity)+1;$("#quantity_text").val(quantity);$("label[for='quantity']").html(quantity);}function decreaseQuantityInProductPage(){var quantity=$("#quantity_text").val();quantity=parseInt(quantity)-1;if(parseInt(quantity)>0){$("#quantity_text").val(quantity);$("label[for='quantity']").html(quantity);}console.log("quantity is "+$("#quantity_text").val());}function addToCartFromProductPage(pid,price,name,image,addToCartType){var size=$("#selected_size").val();var source="PRODUCT_PAGE";addToCart(source,size,pid,price,name,image,addToCartType,undefined);}function addToCart(source,size,pid,price,name,image,addToCartType,stock){var sizelength=$("#sizes_length").val();var isNoSizeProduct=$("#is_nosize_product").val();if(size=='NIL'&&sizelength>0&&source==='PRODUCT_PAGE'&&isNoSizeProduct==='false'){$("#pop_a").popover('show');return;}if(size=='NIL'){size='NA';}var cart=localStorage.getItem("cart");var products=JSON.parse(cart);var quantity=$('#quantity_text').val();if('ADDTOCART'!=addToCartType){quantity=1;}if(quantity===undefined){quantity=1;}if(undefined===stock){stock=$("#"+size+"-stock").val();}if(parseInt(stock)<parseInt(quantity)){console.log("No stock");quantity=stock;$("#quantity_text").val(quantity);$("label[for='quantity']").html(quantity);}console.log("stock is "+stock+" size is "+size+" quantity is "+quantity);if(products==null){products=new Array();}var isDuplicate=false;for(i=0;i<products.length;i++){if(sameProduct(products[i],pid,size)){var newQuantity=(parseInt(products[i].quantity)+parseInt(quantity));console.log("newQuantity = "+newQuantity+" stock = "+stock);if(newQuantity>=stock){newQuantity=parseInt(stock);products[i].quantity=parseInt(stock);}var newPrice=parseInt(price)*newQuantity;products[i].quantity=newQuantity;products[i].price=newPrice;isDuplicate=true;}}if(!isDuplicate){var updatedPrice=parseInt(quantity)*parseInt(price);product={pid:pid,name:name,price:updatedPrice,image:image,quantity:quantity,size:size,unitPrice:parseInt(price),stock:stock};products.push(product);}var savedProducts=$.ajax({url:"/cart/addToCart",method:'POST',contentType:"application/json",data:JSON.stringify(products),global:false,async:false,success:function(data){return data;}}).responseText;if(savedProducts==="authorized"){localStorage.clear();}else if(savedProducts==="unauthorized"){localStorage.setItem("cart",JSON.stringify(products));}$("#already_cart_attempted").val("addToCartButtonClicked");$("#myModal2").modal('show');console.log("displaying cart from addToCart");displayCart();}function decreaseOneQuantityFromCart(pid,size){var cart=localStorage.getItem("cart");var products=JSON.parse(cart);var quantity=1;if(products==null){reduceOneQuantityFromServer(pid,size);return;}var isDuplicate=false;for(i=0;i<products.length;i++){var p=products[i];if(p.pid===pid&&p.size===size){var newQuantity=(parseInt(products[i].quantity)-parseInt(quantity));var newPrice=parseInt(products[i].unitPrice)*newQuantity;if(newQuantity>0){products[i].quantity=newQuantity;products[i].price=newPrice;}}}for(i=0;i<products.length;i++){}var savedProducts=$.ajax({url:"/cart/addToCart",method:'POST',contentType:"application/json",data:JSON.stringify(products),global:false,async:false,success:function(data){return data;}}).responseText;if(savedProducts==="authorized"){localStorage.clear();}else if(savedProducts==="unauthorized"){localStorage.setItem("cart",JSON.stringify(products));}$("#already_cart_attempted").val("addToCartButtonClicked");$("#myModal2").modal('show');displayCart();}function reduceOneQuantityFromServer(pidToBeRemoved,size){var savedProducts=$.ajax({url:"/cart/reduceOneQuantityFromCart/"+pidToBeRemoved+"/size/"+size,method:'GET',global:false,async:false,success:function(data){if(data==="unauthorized"||data==="false"){}displayCart();return data;}}).responseText;}function sameProduct(p,pid,size){if(p.pid===pid&&p.size===size){return true;}return false;}